<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Summer CAM WDD Using AI</title>
    <!-- Bootstrap CSS -->
    <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .banner {
            background-color: silver;
            color: white;
            text-align: center;
            padding: 50px 0;
            font-size: 2em;
        }
        main .row > div {
            border: 1px solid #000;
            padding: 10px;
            margin-bottom: 10px;
            border-bottom: 1px solid #000; /* Added bottom border */
        }
        img {
            width: 100%;
            height: auto;
        }
        #div9 {
            background-color: black;
            color: red;
        }
        .image-container {
            display: flex;
            flex-wrap: wrap;
        }
        .image-container canvas {
            margin: 5px;
        }
        .image-container div {
            text-align: center;
            margin: 5px;
        }
    </style>


<script src="data.js"></script>
</head>
<body>
    <div class="container-fluid">
        <div class="row">
            <div class="col-12 banner">
                Summer CAM WDD Using AI
            </div>
        </div>
    </div>

    <main class="container mt-4">
        <div class="row">
            <div id="div1" class="col-12">
                <h2>Section 1. What is a convolutional neural network?</h2>
                <ul>
                    <li>It tries to find an edge or pattern in an image.</li>
                    <li>It usually consists of one or more convolution plus pooling layer, and one fully connected (FC) layer.</li>
                    <li>When doing convolution on an image, we use a 5x5 filter. Further, we may apply several such filters to detect edge/pattern along several lines.</li>
                    <li>The cost function will be.</li>
                    <li>The last layer is output layer where we use a so-called Sigmoid activation, so that several outputs can be used.
                        <br><img src="convolutionExample3.jpg" alt="Convolution Example" width="600" height="300">
                    </li>
                </ul>
            </div>
            <div id="div2" class="col-12">
                <h2>Section 2. Load TensorFlow for JavaScript libraries</h2>
                <p>We will use TensorFlow.js to train the model.</p>
                <p>Click the 'Run' button below to import two JavaScript libraries.</p>
                <p>import https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@1.0.0/dist/tf.min.js for defining and training models</p>
                <p>import https://cdn.jsdelivr.net/npm/@tensorflow/tfjs-vis@1.0.2/dist/tfjs-vis.umd.min.js for web browser visualization</p>
                <button id="runButton" class="btn btn-primary">Run</button>
            </div>
            <div id="div3" class="col-12"></div>
            <div id="div4" class="col-12">
                <h2>Section 3. The dataset of images</h2>
                <p>We will use a dataset from Google, <a href="https://storage.googleapis.com/learnjs-data/model-builder/mnist_images.png">https://storage.googleapis.com/learnjs-data/model-builder/mnist_images.png</a>, and their labels, <a href="https://storage.googleapis.com/learnjs-data/model-builder/mnist_labels_uint8">https://storage.googleapis.com/learnjs-data/model-builder/mnist_labels_uint8</a>.</p>
                <p>The dataset is a big image file. It contains 65,000 images, each of size 28 x 28 x 1. The label file contains 65,000 labels. Each image uses 10 numbers to indicate which digit the image represents.</p>
            </div>
            <div id="div5" class="col-12">
                <h2>Section 4. The JavaScript module to process the dataset</h2>
                <p>We will use a JavaScript class from './data.js' to process the dataset.</p>
                <button id="loadDatasetButton" class="btn btn-primary" onclick="loadDataset()">Load the dataset</button>
            </div>
            <div id="div6" class="col-12"></div>
            <div id="div7" class="col-12">
                <h2>Section 5. We will show 20 images from the dataset</h2>
                <button id="showImagesButton" class="btn btn-primary">Show the first 20 images</button>
                <div class="image-container" id="imageContainer"></div>
            </div>
            <div id="div8" class="col-12">
                <h2>Section 6. Define a CNN.</h2>
                <p>Our CNN has input of shape 28 x 28 x 1.</p>
                <p>The first layer is a convolution + pooling. We will use 8 filters, each filter has kernel size=5 x 5 and stride =1. The activation function is ‘relu’. We use the max pooling of size 2 x 2 with stride=[2,2].</p>
                <p>The second layer is also a convolution + pooling. This time, we use 16 filters each of kernel size=5x5 and stride =1. The activation function is also ‘relu’. We use the max pooling of size 2 x 2 with stride=[2,2].</p>
                <p>The third layer is a fully connected layer with shape * x 1.</p>
                <p>The last layer is the output layer, with 10 outputs representing 10 digits. The activation function is now ‘softmax’.</p>
                <button id="defineModelButton" class="btn btn-primary">Define the model</button>
            </div>
            <div id="div9" class="col-12">Content for div9</div>
            <div id="div10" class="col-12">
                <h2>Section 7. Train the model using 5000 images</h2>
                <p>The batch size = 512, and epochs = 10</p>
                <p>The test size = 1000</p>
                <p>The callbacks have name='Model Training', tab='Model', styles='{height: 400px}', metrics={'loss', 'val_loss', 'acc', 'val_acc'}</p>
                <button id="trainModelButton" class="btn btn-primary">Train the model</button>
            </div>
            <div id="div11" class="col-12">Content for div11</div>
            <div id="div12" class="col-12">
                <h2>Section 8. Evaluate the model</h2>
                <p>We will obtain 500 images from the dataset mnistData.</p>
                <p>We use the trained model to calculate the predictions and then compare the predictions with the provided labels.</p>
                <p>We then draw a confusion matrix to show for each digit, how many images are labeled for that digit and how many images that predicted to that digit. Further, how many difference.</p>
                <button id="showConfusionMatrixButton" class="btn btn-primary">Show a confusion matrix</button>
            </div>
            <div id="div13" class="col-12">Content for div13</div>
            <div id="div14" class="col-12"></div>
            


        </div>
    </main>

    <!-- Bootstrap JS and dependencies -->
    <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.9.3/dist/umd/popper.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@1.0.0/dist/tf.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs-vis@1.0.2/dist/tfjs-vis.umd.min.js"></script>
    <script>
        let globalModel; // Global variable to store the model

        document.getElementById('runButton').addEventListener('click', function() {
            const script1 = document.createElement('script');
            script1.src = 'https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@1.0.0/dist/tf.min.js';
            script1.onload = () => {
                console.log('TensorFlow.js loaded');
                document.getElementById('div3').innerText += 'TensorFlow.js loaded\n';
            };
            
            const script2 = document.createElement('script');
            script2.src = 'https://cdn.jsdelivr.net/npm/@tensorflow/tfjs-vis@1.0.2/dist/tfjs-vis.umd.min.js';
            script2.onload = () => {
                console.log('TensorFlow.js Vis loaded');
                document.getElementById('div3').innerText += 'TensorFlow.js Vis loaded\n';
            };
            
            document.body.appendChild(script1);
            document.body.appendChild(script2);
        });

    
        let mnistData;
    async function loadDataset() {
      try {
        mnistData = new MnistData();
        await mnistData.load();
        displayDatasetShape(mnistData);


        //console.log('Dataset and labels loaded successfully');
      } catch (error) {
        console.error('Error loading dataset and labels:', error);
      }
    }
    function displayDatasetShape(data) {
      const images = data.trainImages;
      const labels = data.trainLabels;
      const imagesShape = images.length;
      const labelsShape = labels.length;
      document.getElementById('div6').innerText = `Images shape: ${imagesShape}, Labels shape: ${labelsShape}`; 
    }

        document.getElementById('showImagesButton').addEventListener('click', function() {
            const container = document.getElementById('imageContainer');
            container.innerHTML = ''; // Clear any existing images

            const numImages = 20;
            const imageSize = 28;
            const canvasSize = 56; // Double the size for better visibility

            for (let i = 0; i < numImages; i++) {
                const canvas = document.createElement('canvas');
                canvas.width = canvasSize;
                canvas.height = canvasSize;
                const ctx = canvas.getContext('2d');
                const imageData = ctx.createImageData(imageSize, imageSize);

                const data = mnistData.trainImages.slice(i * imageSize * imageSize, (i + 1) * imageSize * imageSize);
                for (let j = 0; j < data.length; j++) {
                    const pixel = data[j] * 255;
                    imageData.data[j * 4] = pixel; // Red
                    imageData.data[j * 4 + 1] = pixel; // Green
                    imageData.data[j * 4 + 2] = pixel; // Blue
                    imageData.data[j * 4 + 3] = 255; // Alpha
                }

                ctx.putImageData(imageData, 0, 0);
                ctx.scale(2, 2); // Scale the image for better visibility
                ctx.drawImage(canvas, 0, 0);

                const label = mnistData.trainLabels.slice(i * 10, (i + 1) * 10);
                const labelDiv = document.createElement('div');
                labelDiv.textContent = `Label: ${label}`;
                
                const surfaceElement = document.createElement('div');
                surfaceElement.appendChild(canvas);
                surfaceElement.appendChild(labelDiv);

                container.appendChild(surfaceElement);
            }
        });

        document.getElementById('defineModelButton').addEventListener('click', function() {
            const model = tf.sequential();

            model.add(tf.layers.conv2d({
                inputShape: [28, 28, 1],
                filters: 8,
                kernelSize: 5,
                strides: 1,
                activation: 'relu',
                kernelInitializer: 'varianceScaling'
            }));

            model.add(tf.layers.maxPooling2d({
                poolSize: [2, 2],
                strides: [2, 2]
            }));

            model.add(tf.layers.conv2d({
                filters: 16,
                kernelSize: 5,
                strides: 1,
                activation: 'relu',
                kernelInitializer: 'varianceScaling'
            }));

            model.add(tf.layers.maxPooling2d({
                poolSize: [2, 2],
                strides: [2, 2]
            }));

            model.add(tf.layers.flatten());

            model.add(tf.layers.dense({
                units: 10,
                kernelInitializer: 'varianceScaling',
                activation: 'softmax'
            }));

            model.compile({
                optimizer: 'adam',
                loss: 'categoricalCrossentropy',
                metrics: ['accuracy']
            });

            globalModel = model; // Save the model to a global variable

        
            model.build();
            const summaryElement = document.getElementById('div9');
            //const tfvis = require('@tensorflow/tfjs-vis');
            tfvis.show.modelSummary(summaryElement, model);

       });

        document.getElementById('trainModelButton').addEventListener('click', async function() {
            const batchSize = 512;
            const epochs = 10;
            const trainSize = 5000;
            const testSize = 1000;

            globalModel.compile({
                optimizer: 'adam',
                loss: 'categoricalCrossentropy',
                metrics: ['accuracy']
            });

            const [trainXs, trainYs] = tf.tidy(() => {
                const trainData = mnistData.nextTrainBatch(trainSize);
                return [
                    trainData.xs.reshape([trainSize, 28, 28, 1]),
                    trainData.labels
                ];
            });

            const [testXs, testYs] = tf.tidy(() => {
                const testData = mnistData.nextTestBatch(testSize);
                return [
                    testData.xs.reshape([testSize, 28, 28, 1]),
                    testData.labels
                ];
            });

           // const surface = { name: 'Model Training', tab: 'Model', styles: { height: '400px' } };

            const surface = document.getElementById('div11');
            await globalModel.fit(trainXs, trainYs, {
                batchSize,
                epochs,
                validationData: [testXs, testYs],
                callbacks: tfvis.show.fitCallbacks(surface, ['loss', 'acc'])
            });

            trainXs.dispose();
            trainYs.dispose();
            testXs.dispose();
            testYs.dispose();
        });

        document.getElementById('showConfusionMatrixButton').addEventListener('click', async function() {
            const testSize = 500;
            const [testXs, testYs] = tf.tidy(() => {
                const testData = mnistData.nextTestBatch(testSize);
                return [
                    testData.xs.reshape([testSize, 28, 28, 1]),
                    testData.labels
                ];
            });

            const predictions = globalModel.predict(testXs).argMax(-1);
            const labels = testYs.argMax(-1);

            const classAccuracy = await tfvis.metrics.perClassAccuracy(labels, predictions);
            const confusionMatrix = await tfvis.metrics.confusionMatrix(labels, predictions);

            //const container = { name: 'Per Class Accuracy', tab: 'Evaluation' };
            const container=document.getElementById('div13');
            tfvis.show.perClassAccuracy(container, classAccuracy);

            const container2 = document.getElementById('div14');
          //  const container2 = { name: 'Confusion Matrix', tab: 'Evaluation' };
            tfvis.render.confusionMatrix(container2, {
                values: confusionMatrix,
                tickLabels: ['0', '1', '2', '3', '4', '5', '6', '7', '8', '9']
            });

            testXs.dispose();
            testYs.dispose();
        });
    </script>
</body>
</html>